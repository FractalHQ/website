---
import SettingsModal from '$components/posts/SettingsModal.svelte';
import { faRss, faCog } from '@fortawesome/free-solid-svg-icons';
import { faTwitter } from '@fortawesome/free-brands-svg-icons';
import { CollectionEntry, getCollection } from 'astro:content';
import Contents from '$components/posts/Contents.svelte';
import { tweetLink } from '$helpers/twitter';
import Page from '$layouts/Page.astro';
import { format } from 'date-fns';
import '$layouts/post.scss';
import Fa from 'svelte-fa';

export async function getStaticPaths() {
    const blogPosts = await getCollection('blog');

    return blogPosts.map((post) => ({
        params: { slug: post.slug },
        props: { post },
    }));
}

const post = Astro.props.post as CollectionEntry<'blog'>;
const { Content, headings } = await post.render();

console.log(headings);
---

<Page frontmatter={post.data}>
    <article>
        <div class="meta">
            <h1>{post.data.title}</h1>
            <p>{format(post.data.timestamp, 'do LLLL yyyy')}</p>
        </div>

        <div class="split">
            <div class="markdown" id="post-body">
                <Content />
            </div>

            <aside class="contents">
                <h2 class="title">Table Of Contents</h2>

                <Contents client:load headings={headings} />

                <div class="settings">
                    <SettingsModal client:load inline />
                </div>
            </aside>
        </div>

        <hr />

        <footer>
            <div class="row wrap">
                <a
                    href={tweetLink(
                        `Checkout this post by @onlyspaceghost!\n\nhttps://ghostdev.xyz/posts/${post.slug}`,
                    )}
                    class="button"
                    target="_blank"
                >
                    <Fa icon={faTwitter} />
                    Share on twitter
                </a>

                <a href="/rss.xml" target="_blank" class="button">
                    <Fa icon={faRss} />
                    RSS
                </a>
            </div>

            <SettingsModal client:load />
        </footer>
    </article>
</Page>

<style lang="scss">
    @import 'src/helpers/media';

    article {
        width: 100%;
        max-width: 100%;

        display: flex;
        flex-direction: column;
        gap: 16px;

        footer {
            width: 100%;
            padding-bottom: 16px;

            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;

            @include media('<600px') {
                flex-wrap: wrap;
            }
        }

        .split {
            display: grid;
            grid-template-columns: 1fr max-content;
            gap: 80px;

            position: relative;
        }

        .markdown {
            overflow: auto;
        }

        .contents {
            display: flex;
            flex-direction: column;
            align-self: flex-start;
            align-items: flex-start;
            gap: 8px;

            position: sticky;
            top: 150px;

            .title {
                font-size: 1.4rem;
            }

            .settings {
                margin-top: 16px;
            }
        }

        .meta {
            background-color: var(--background-secondary);
            border-radius: 22px;
            padding: 32px;

            display: flex;
            flex-direction: column;
            gap: 12px;

            margin-bottom: 32px;
        }
    }
</style>
